<div class="list folders">
	<div class="scroller" ref:list>
		{#each folders as folder}
			<div
				tabindex="0"
				class="list-item folder {folder.name === $folder ? 'selected' : ''} {folder.cls || ''}"
				on:focus="open(folder.name)"
				on:dragover="ondragenter(event)"
				on:dragenter="ondragenter(event)"
				on:dragleave="ondragleave(event)"
				on:drop="ondrop(event, folder.name)">
					{folder.name || 'All Notes'}
					<span class="list-item-badge">{folder.count}</span>
				</div>
		{/each}
	</div>
</div>

<script>
import {Data, Store, EVENT} from '../data';
export default {
	store: () => Store,
	computed: {
		folders ({$notes}) {
			const map = {};
			const folders = [];
			const binned = $notes.filter(n => n.deleted_at);
			const all = $notes.filter(n => !n.deleted_at);

			for (let note of all) {
				if (note.folder) map[note.folder] = (map[note.folder] || 0) + 1;
			}
			for (let name in map) folders.push({ name, count: map[name] });
			folders.sort((a, b) => a.name.localeCompare(b.name));
			folders.unshift({ name: '', count: $notes.length - binned.length });
			if (binned.length) folders.push({ name: 'Bin', count: binned.length, cls: 'folder-bin' });
			return folders;
		}
	},
	oncreate () {
		EVENT.on(EVENT.focus.selectedFolder, this.focusSelectedFolder.bind(this));
	},
	methods: {
		focusSelectedFolder () {
			document.querySelector('.folders .folder.selected').focus();
		},

		open (folder) {
			if (this.store.get().mode === 'view') this.store.set({ folder, note: null });
			else EVENT.fire(EVENT.focus.editor);
		},
		onclick (ev, folder) {
			ev.preventDefault();
			this.open(folder);
		},

		ondragenter (ev) {
			ev.preventDefault();
			ev.target.classList.add('drag-over');
		},

		ondragleave (ev) {
			ev.target.classList.remove('drag-over');
		},

		ondrop (ev, folder) {
			ev.preventDefault();
			ev.target.classList.remove('drag-over');

			const itemId = +ev.dataTransfer.getData('itemId');
			const notes = this.store.get().notes;
			const note = notes.find(note => note.id === itemId);
			note.folder = folder;

			Data.Notes.save(note).then(res => {
				this.store.set({ notes });
			});
		},

	}
};
</script>
