<div class="editor {$mode}">
	{#if $markedNote}
	<form on:submit="save(event)">
		<div class="editor-header">
			<div class="editor-header-row view">
				<span class="note-title">{$markedNote.title || ''}</span>
				<div class="flex-filler"></div>
				<button type="button" class="btn-icon ion-md-create btn-edit" on:click="edit($markedNote)" title="Edit (e)"></button>
			</div>
			<div class="editor-header-row edit">
				<label>Folder:</label>
				<input bind:value="note.folder" placeholder="folder" on:keydown="onkeydown(event)">
				<div class="flex-filler"></div>
				<button type="submit" class="btn-icon ion-md-checkmark btn-save success" title="Save (Enter)"></button>
				{#if note.id}
				<button type="button" class="btn-icon ion-md-trash btn-remove danger" on:click="del(note.id)" title="Delete"></button>
				{/if}
				<button type="button" class="btn-icon ion-md-close btn-cancel" on:click="cancel()" title="Cancel (Esc)"></button>
			</div>
			<div class="editor-header-row edit">
				<input class="input-wide" bind:value="note.title" ref:title on:keydown="onkeydown(event)" placeholder="New note">
			</div>
		</div>

		<div class="scroller">
			{#if $mode === 'view'}
				<div class="note-text">{@html $markedNote.markedText || ''}</div>
			{:else}
				<textarea bind:value="note.text" on:keydown="onkeydown(event)"></textarea>
			{/if}
		</div>
	</form>
	{/if}
</div>


<script>
import {Data, Store} from '../data';

export default {
	store: () => Store,
	data () {
		return { note: {} }
	},
	oncreate () {
		this.store.on('state', ({ current, previous, changed }) => {
			if (changed.note && current.note) {
				if (!current.note.id) this.edit();
			}
		});
	},
	methods: {
		onkeydown (ev) {
			if (this.store.get().mode === 'edit') {
				if (ev.key === 'Escape') {
					ev.preventDefault();
					ev.stopPropagation();
					this.cancel();
				}
				else if (ev.key === 'Enter' && (ev.metaKey || ev.ctrlKey)) {
					this.save();
				}
			}
		},

		edit () {
			const {mode, note} = this.store.get();
			if (mode !== 'edit') {
				this.store.set({ mode: 'edit' });
				this.set({ note: Object.assign({}, note) });
				setTimeout(() => this.refs.title.select(), 100);
			}
		},

		cancel () {
			const note = this.get().note;
			const noNote = (!note || !note.id);
			this.store.set({ mode: 'view' });

			if (noNote) this.store.set({ note: null });
			else document.querySelector('.notes .note.selected').focus();
		},

		save (e) {
			if (e) e.preventDefault();
			let note = this.get().note;
			Data.Notes.save(note).then(res => {
				if (res.id) note = res;
				this.updateNoteInStore(note);
				this.cancel();
				this.store.set({ note, folder: '' });
			});
		},

		updateNoteInStore (note) {
			const notes = this.store.get().notes;
			const idx = notes.findIndex(n => n.id === note.id);
			if (idx > -1) notes[idx] = note;
			else notes.push(note);
			this.store.set({ notes, note });
		},

		del (id) {
			if (!id) id = this.store.get().note.id;
			if (!id) return;
			const notes = this.store.get().notes;
			const idx = notes.findIndex(n => n.id === id);
			if (window.confirm(`Are you sure you wish to delete "${notes[idx].title}"`)) {
				Data.Notes.del(id).then(res => {
					this.close();
					if (idx > -1) notes.splice(idx, 1);
					this.store.set({ notes });
				});
			}
		},

		close () {
			this.store.set({ mode: 'view', note: null });
		}
	}
};
</script>
