<div class="editor {$mode}">
	{#if $note}
	<form on:submit="save(event)">
		<div class="editor-header">
			<div class="editor-header-row view">
				<span class="note-title">{$note.title || ''}</span>
				<div class="flex-filler"></div>
				<button type="button" class="btn btn-edit" on:click="edit($note)">Edit</button>
			</div>
			<div class="editor-header-row edit">
				<label>Title:</label>
				<input bind:value="$note.title" ref:title on:keydown="onkeydown(event)">
				<div class="flex-filler"></div>
				<button type="submit" class="btn btn-save success">Save</button>
				<button type="button" class="btn btn-remove danger" on:click="del($note.id)">Delete</button>
				<button type="button" class="btn btn-cancel" on:click="cancel()">Cancel</button>
			</div>
			<div class="editor-header-row edit">
				<label>Folder:</label>
				<input bind:value="$note.folder" placeholder="folder" on:keydown="onkeydown(event)">
				<div class="flex-filler"></div>
			</div>
		</div>

		<div class="scroller">
			{#if $mode === 'view'}
				<div class="note-text">{$note.text || ''}</div>
			{:else}
				<textarea bind:value="$note.text" on:keydown="onkeydown(event)"></textarea>
			{/if}
		</div>
	</form>
	{/if}
</div>


<script>
import {Data, Store} from '../data';

export default {
	store: () => Store,
	oncreate () {
		this.store.on('state', ({ current, previous, changed }) => {
			if (changed.note && current.note) {
				if (!current.note.id && this.store.get().mode !== 'edit') this.edit();
			}
		});
	},
	methods: {
		onkeydown (ev) {
			if (this.store.get().mode === 'edit') {
				if (ev.key === 'Escape') {
					ev.preventDefault();
					ev.stopPropagation();
					this.cancel();
				}
			}
		},

		edit () {
			const mode = this.store.get().mode;
			if (mode === 'view') {
				this.store.set({ mode: 'edit' });
				setTimeout(() => this.refs.title.select(), 100);
			}
		},

		cancel () {
			const note = this.store.get().note;
			if (!note || !note.id) this.store.set({ note: null });
			this.store.set({ mode: 'view' });
			document.querySelector('.notes .note.selected').focus();
		},

		save (e) {
			e.preventDefault();
			let note = this.store.get().note;
			Data.Notes.save(note).then(res => {
				if (res.id) note = res;
				this.updateNoteInStore(note);
				this.cancel();
			});
		},

		updateNoteInStore (note) {
			const notes = this.store.get().notes;
			const idx = notes.findIndex(n => n.id === note.id);
			if (idx > -1) notes[idx] = note;
			else notes.push(note);
			this.store.set({ notes, note });
		},

		del (id) {
			Data.Notes.del(id).then(res => {
				this.close();
				const notes = this.store.get().notes;
				const idx = notes.findIndex(n => n.id === id);
				if (idx > -1) notes.splice(idx, 1);
				this.store.set({ notes });
			});
		},

		close () {
			this.store.set({ mode: 'view', note: null });
		}
	}
};
</script>
