<script>
import CommandPalette from './command-palette';
import {Data, Store, EVENT} from '../data';
import {timeAgo} from '../util';

export default {
	store: () => Store,
	oncreate () {
		this.palette = new CommandPalette({
			searchInFields: ['title', 'folder', 'text'],
			dataSrc: () => this.store.get().notes,
			sizeContainer: 'body',
			itemRenderer: ({title, text, folder, updated_at, highlighted}) => {
				if (highlighted) {
					if (highlighted.title) title = highlighted.title;
					if (highlighted.text) text = highlighted.text;
					if (highlighted.folder) folder = highlighted.folder;
				}
				return `<div class="item-name">
						${title}
						<span class="pill">${folder}</span>
						<span class="pill">updated: ${timeAgo(updated_at)}</span>
					</div>
					<span class="item-sub">${text}</span>`;
			}
		});

		this.palette.on('action', this.onNoteSelect.bind(this));

		document.addEventListener('keydown', this.onkeydown.bind(this));
		EVENT.on(EVENT.palette.show, () => this.palette.open());
	},

	methods: {
		onNoteSelect (note) {
			this.store.set({ note, folder: '' });
			setTimeout(() => EVENT.fire(EVENT.focus.selectedNote), 10);
		},

		onkeydown (ev) {
			if (this.palette.state.open) return;

			const {note} = this.store.get();
			const isEdit = (this.store.get().mode === 'edit');
			const newNote = () => EVENT.fire(EVENT.note.new);
			const editNote = () => { if (note) EVENT.fire(EVENT.edit.start); };
			const delNote = () => { if (ev.metaKey || ev.ctrlKey) EVENT.fire(EVENT.note.del); };

			const keymap = {
				e: editNote,
				Enter: editNote,
				Backspace: delNote,
				n: newNote,
				ArrowUp: () => this.goto('up'),
				ArrowDown: () => this.goto('down'),
				ArrowRight: () => this.goto('right'),
				ArrowLeft: () => this.goto('left'),
			};
			if (keymap[ev.key] && !isEdit) keymap[ev.key]();
		},

		goto (where) {
			if (where === 'folders') return EVENT.fire(EVENT.focus.selectedFolder);
			if (where === 'notes') return EVENT.fire(EVENT.focus.firstNote);

			const elem = document.activeElement;
			const isNotes = elem && elem.closest('.notes');
			const isFolders = elem && elem.closest('.folders');
			const isEditor = elem && elem.closest('.editor');

			if (!isFolders && !isNotes && !isEditor) return EVENT.fire(EVENT.focus.firstNote);

			if (where === 'left') {
				if (isNotes) return EVENT.fire(EVENT.focus.selectedFolder);
				if (isEditor) return EVENT.fire(EVENT.focus.selectedNote);
			}
			else if (where === 'right') {
				if (isFolders) return EVENT.fire(EVENT.focus.firstNote);
				if (isNotes) return EVENT.fire(EVENT.focus.editorView);

			}

			let newElem;
			if (where === 'up') newElem = elem.previousElementSibling;
			else if (where === 'down') newElem = elem.nextElementSibling;

			if (newElem && newElem.matches('.list-item')) newElem.focus();
		},

	}
};
</script>
