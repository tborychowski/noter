<script>
import CommandPalette from './command-palette';
import {Data, Store} from '../data';

export default {
	store: () => Store,

	oncreate () {
		this.palette = new CommandPalette({
			searchInFields: ['title', 'text'],
			dataSrc: () => this.store.get().notes,
			sizeContainer: 'body',
			itemRenderer: ({title, text, highlighted}) => {
				if (highlighted) {
					if (highlighted.title) title = highlighted.title;
					if (highlighted.text) text = highlighted.text;
				}
				return `<div class="item-name">${title}</div>
					<span class="item-sub">${text}</span>`;
			}
		});

		this.palette.on('action', this.onNoteSelect.bind(this));

		document.addEventListener('keydown', this.onkeydown.bind(this));
	},

	methods: {
		show ()  {
			this.palette.open();
		},

		onNoteSelect (note) {
			this.store.set({ note, folder: '' });
			setTimeout(() => document.querySelector('.notes .note.selected').focus(), 10);
		},

		onkeydown (ev) {
			if (this.palette.state.open) return;

			const {note} = this.store.get();
			const isEdit = (this.store.get().mode === 'edit');
			const editNote = () => { if (note) this.action('start-edit'); };
			const delNote = () => { if (ev.metaKey || ev.ctrlKey) this.action('del-note'); };

			const keymap = {
				e: editNote,
				Enter: editNote,
				Backspace: delNote,
				n: () => this.action('new-note'),
				ArrowUp: () => this.goto('up'),
				ArrowDown: () => this.goto('down'),
				ArrowRight: () => this.goto('notes'),
				ArrowLeft: () => this.goto('folders'),
			};

			if (keymap[ev.key] && !isEdit) keymap[ev.key]();
		},

		goto (where) {
			if (where === 'folders') return document.querySelector('.folders .folder.selected').focus();
			if (where === 'notes') return document.querySelector('.notes .note').focus();
			if (where === 'up' || where === 'down') {
				const elem = document.activeElement;
				const isList = elem && elem.closest('.list');
				if (!isList) return document.querySelector('.notes .note').focus();

				let newElem;
				if (where === 'up') newElem = elem.previousElementSibling;
				else if (where === 'down') newElem = elem.nextElementSibling;

				if (newElem && newElem.matches('.list-item')) newElem.focus();
			}
		},

		action (action) {
			this.fire('action', { action });
		}
	}
};
</script>
