<div class="list notes">
	<div class="scroller">
		{#each $notesInFolder as item}
		<div
			class="list-item note {isSelected(item, $note) ? 'selected' : ''}"
			draggable="true"
			tabindex="0"
			on:focus="open(null, item)"
			on:dragstart="ondragstart(event, item)">
				<div class="note-details">
					<div class="note-title">{item.title}</div>
					<div class="list-item-badge">{item.folder}</div>
					<div class="list-item-badge">{timeAgo(item.updated_at)}</div>
				</div>
				{#if item.thumb}
					<div class="note-thumb" style="background-image: url('{item.thumb}')"></div>
				{/if}
		</div>
		{/each}
	</div>
</div>


<script>
import {Data, Store, EVENT} from '../data';
import {timeAgo, getImageFromMarkdown} from '../util';

export default {
	store: () => Store,
	helpers: {
		isSelected (item, selected) {
			if (!selected || !item) return false;
			return selected.id === item.id;
		},
		timeAgo
	},
	oncreate () {
		EVENT.on(EVENT.notes.load, this.load.bind(this));
		EVENT.on(EVENT.focus.firstNote, this.focusFirstNote.bind(this));
		EVENT.on(EVENT.focus.selectedNote, this.focusSelectedNote.bind(this));
	},
	methods: {
		load () {
			Data.Notes.get().then(notes => {
				notes.forEach(n => { n.thumb = getImageFromMarkdown(n.text); });

				this.store.set({ notes });

				const selectedNote = this.store.get().note;
				if (selectedNote && selectedNote.id && !selectedNote.title) {
					const note = notes.find(n => n.id === selectedNote.id);
					this.store.set({ note });
					EVENT.fire(EVENT.focus.selectedNote);
				}
			});

		},

		ondragstart (ev, item) {
			ev.dataTransfer.setData('itemId', item.id);
		},

		focusFirstNote () {
			document.querySelector('.notes .note').focus();
		},

		focusSelectedNote () {
			document.querySelector('.notes .note.selected').focus();
		},

		open (ev, note) {
			if (ev) ev.preventDefault();
			if (this.store.get().mode === 'view') this.store.set({ note });
			else EVENT.fire(EVENT.focus.editor);
		}
	}
};
</script>
