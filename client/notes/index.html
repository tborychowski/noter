<div class="notes">
	{#if $folder}
	<h2>
		<span>{$folder.name || ''}</span>
		<div class="flex-filler"></div>
		<button class="btn" on:click="deleteFolder($folder.id)">Delete</button>
		<button class="btn" on:click="add()">+</button>
	</h2>
	<div class="scroller">
		{#each notes as item}
		<a href="#"
		class="note {isSelected(item, selected) ? 'selected' : ''}"
		on:click="select(event, item)">{item.title}</a>
		{/each}
	</div>
	{/if}
</div>


<script>
import {Data, Store} from '../data';


export default {
	data () {
		return {
			isLoading: true,
			selected: null,
			items: [],
		};
	},
	store: () => Store,
	oncreate () {
		this.store.on('state', ({ current, changed }) => {
			if (changed.folder) {
				this.set({ selected: null });
				this.load(current.folder);
			}
			if (changed.note) {
				this.set({ selected: current.note });
			}
		});
	},
	computed: {
		notes ({items}) {
			return items.sort((a, b) => a.title.localeCompare(b.title));
		}
	},
	helpers: {
		isSelected (item, selected) {
			if (!selected || !item) return false;
			return selected.id === item.id;
		}
	},

	methods: {
		load (folder) {
			if (!folder) return;
			this.set({ isLoading: !this.get().items.length, items: [] });
			Data.Notes.get(folder.id).then(items => {
				this.set({ items, isLoading: false });
				const note = this.store.get().note;
				if (note) this.select(note);
			});
		},

		add () {
			const folder_id = this.get().folder.id;
			Data.Notes
				.save({ id: null, name: 'New note', folder_id })
				.then(item => {
						const items = this.get().items;
						items.unshift(item);
						this.set({ items });
						this.select(item);
					});
		},

		select (ev, item) {
			ev.preventDefault();
			this.set({ selected: item });
			this.store.set({ note: item });
		},

		deleteFolder (id) {
			// remove all notes from folder?
			Data.Folders.del(id).then(res => {
				this.fire('folder-delete');
			});
		}
	}
};
</script>
