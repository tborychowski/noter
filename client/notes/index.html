<div class="list notes">
	<div class="scroller" ref:notelistel>
		{#each $notesInFolder as item}
		<div
			class="list-item note {isSelected(item, $selectedNotes) ? 'selected' : ''} note-{item.id}"
			data-id="{item.id}"
			draggable="true"
			tabindex="0"
			on:focus="open(event, item)"
			on:mousedown="select(event, item, this)"
			on:dragstart="ondragstart(event, item)">
				<div class="note-details">
					<div class="note-title">{item.title}</div>
					<div class="list-item-badge">{item.folder}</div>
					<div class="list-item-badge">{timeAgo(item.updated_at)}</div>
				</div>
				{#if item.thumb}
					<div class="note-thumb" style="background-image: url('{item.thumb}')"></div>
				{/if}
		</div>
		{/each}
	</div>
</div>


<script>
import {Data, Store, EVENT} from '../data';
import {timeAgo, getImageFromMarkdown, unique} from '../util';

export default {
	store: () => Store,
	helpers: {
		isSelected (item, selectedNotes) {
			if (!selectedNotes.length || !item) return false;
			return !!selectedNotes.find(n => n.id === item.id);
		},
		timeAgo
	},
	oncreate () {
		EVENT.on(EVENT.notes.load, this.load.bind(this));
		EVENT.on(EVENT.focus.firstNote, this.focusFirstNote.bind(this));
		EVENT.on(EVENT.focus.selectedNote, this.focusSelectedNote.bind(this));
		EVENT.on(EVENT.focus.updown, this.focusNoteUpDown.bind(this));
		EVENT.on(EVENT.focus.selectedFolder, this.unselectNotes.bind(this));
	},
	methods: {
		load () {
			Data.Notes.get().then(notes => {
				notes.forEach(n => { n.thumb = getImageFromMarkdown(n.text); });

				this.store.set({ notes });

				const selectedNote = this.store.get().note;
				if (selectedNote && selectedNote.id && !selectedNote.title) {
					const note = notes.find(n => n.id === selectedNote.id);
					this.store.set({ note });
					EVENT.fire(EVENT.focus.selectedNote);
				}
			});

		},

		ondragstart (ev, item) {
			ev.dataTransfer.setData('itemId', item.id);
		},

		focusFirstNote () {
			const noteEl = document.querySelector('.notes .note');
			if (!noteEl) return;
			const note = this.getNoteFromEl(noteEl);
			this.setSelectedNotes([note], true);
			noteEl.focus();
		},

		focusSelectedNote () {
			const {note} = this.store.get();
			const noteEl = this.getElFromNote(note);
			if (note) this.setSelectedNotes([note], true);
			if (noteEl) noteEl.focus();
		},

		select (ev, item, noteEl) {
			if (ev.shiftKey) {
				let {note, notesInFolder} = this.store.get()
				const selectedNotes = [];
				const noteArray = Array.from(noteEl.parentNode.children);
				const noteIdx = noteArray.indexOf(noteEl);
				const focusedEl = this.getElFromNote(note);
				const focusedIdx = noteArray.indexOf(focusedEl);
				const from = Math.min(focusedIdx, noteIdx);
				const to = Math.max(focusedIdx, noteIdx);
				for (let i = from; i <= to; i += 1) {
					selectedNotes.push(notesInFolder[i]);
				}
				this.setSelectedNotes(selectedNotes);
			}
			else if (ev.metaKey) this.toggleSelectedNotes([item]);
			else this.setSelectedNotes([item], true);
		},

		getElFromNote (note) {
			return this.refs.notelistel.querySelector('.note-' + note.id);
		},

		getNoteFromEl (el) {
			const {notesInFolder} = this.store.get();
			const id = parseInt(el.dataset.id, 10) || null;
			return notesInFolder.find(n => n.id === id);
		},

		toggleSelectedNotes (items) {
			let {selectedNotes} = this.store.get()
			items.forEach(item => {
				const idx = selectedNotes.indexOf(item);
				if (idx > -1) selectedNotes.splice(idx, 1);
				else selectedNotes.push(item);
			});
			this.setSelectedNotes(selectedNotes, true);
		},

		setSelectedNotes (notes, replace) {
			let {selectedNotes} = this.store.get()
			if (replace) selectedNotes = [];
			selectedNotes.push(...new Set(notes));
			this.store.set({ selectedNotes: unique(selectedNotes) })
		},

		focusNoteUpDown (ev, where, elem) {
			if (!elem) return;
			ev.preventDefault();

			let newElem;
			if (where === 'up') newElem = elem.previousElementSibling;
			else if (where === 'down') newElem = elem.nextElementSibling;
			if (!newElem) return;

			if (elem.closest('.notes')) {
				const notes = [];
				if (ev.shiftKey) notes.push(this.getNoteFromEl(elem));
				notes.push(this.getNoteFromEl(newElem));
				this.setSelectedNotes(notes, !ev.shiftKey);
			}

			if (newElem && newElem.matches('.list-item')) newElem.focus();
		},

		unselectNotes () {
			this.store.set({ selectedNotes: [] });
		},

		open (ev, note) {
			if (this.store.get().mode === 'view') this.store.set({ note });
			else EVENT.fire(EVENT.focus.editor);
		}
	}
};
</script>
